#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

# mrk1 weekly update checker
# Runs silently unless updates are available

# Configuration
CACHE_DIR="${HOME}/.cache/mrk1"
TIMESTAMP_FILE="${CACHE_DIR}/last-update-check"
CHECK_INTERVAL_DAYS=7
REPO_DIR="${REPO_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)}"

# Exit silently if not in an interactive shell
[[ -t 0 ]] || exit 0

# Create cache directory if needed
mkdir -p "$CACHE_DIR"

# Check if enough time has passed since last check
if [[ -f "$TIMESTAMP_FILE" ]]; then
  last_check=$(cat "$TIMESTAMP_FILE" 2>/dev/null || echo 0)
  now=$(date +%s)
  elapsed_days=$(( (now - last_check) / 86400 ))
  if (( elapsed_days < CHECK_INTERVAL_DAYS )); then
    exit 0
  fi
fi

# Verify repo directory exists and is a git repo
if [[ ! -d "$REPO_DIR/.git" ]]; then
  exit 0
fi

# Fetch updates quietly, exit on network failure
if ! git -C "$REPO_DIR" fetch --quiet 2>/dev/null; then
  exit 0
fi

# Compare local HEAD with remote
local_head=$(git -C "$REPO_DIR" rev-parse HEAD 2>/dev/null) || exit 0
remote_head=$(git -C "$REPO_DIR" rev-parse origin/main 2>/dev/null) || exit 0

# Update timestamp after successful check
date +%s > "$TIMESTAMP_FILE"

# Exit if already up to date
if [[ "$local_head" == "$remote_head" ]]; then
  exit 0
fi

# Check if local is behind remote
if ! git -C "$REPO_DIR" merge-base --is-ancestor "$local_head" "$remote_head" 2>/dev/null; then
  # Local has diverged or is ahead; don't prompt
  exit 0
fi

# Prompt user for update
printf '\033[33mmrk1 updates available.\033[0m Update now? [y/N] '
read -r response </dev/tty
case "$response" in
  [yY]|[yY][eE][sS])
    make -C "$REPO_DIR" update
    ;;
esac
