#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

err() { printf "\033[31m✗ %s\033[0m\n" "$*" >&2; }
ok() { printf "\033[32m✓ %s\033[0m\n" "$*"; }
warn() { printf "\033[33m⚠ %s\033[0m\n" "$*"; }
trap 'err "Failed at ${FUNCNAME[0]:-main} line $LINENO: $BASH_COMMAND"' ERR

[[ "${TRACE:-0}" == "1" ]] && set -x

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
DOTFILES_DIR="${REPO_ROOT}/dotfiles"
SCRIPTS_DIR="${REPO_ROOT}/scripts"

run() {
  printf "+ "
  printf "%q " "$@"
  printf "\n"
  "$@"
}

usage() {
  cat <<'USAGE'
mrk1 bootstrap
Usage: bootstrap [bootstrap|dotfiles|tools|defaults|doctor|help]
USAGE
}

link_dotfiles() {
  if [[ ! -d "${DOTFILES_DIR}" ]]; then
    warn "dotfiles/ missing; skipping"
    return 0
  fi

  for src in "${DOTFILES_DIR}"/.*; do
    [[ -f "$src" ]] || continue
    local base dest target
    base="$(basename "$src")"
    case "$base" in
      .*) dest="${HOME}/${base}" ;;
      *)  dest="${HOME}/.${base}" ;;
    esac
    if [[ -L "$dest" || -e "$dest" ]]; then
      target="$(readlink "$dest" || true)"
      if [[ "$target" == "$src" ]]; then
        ok "symlink exists: $dest"
        continue
      else
        warn "$dest exists; replacing with symlink"
        rm -rf "$dest"
      fi
    fi
    run ln -s "$src" "$dest"
    ok "linked: $dest -> $src"
  done
}

# NEW: robust tool linker (same logic as in install)
link_tools() {
  local src_dir
  if [[ -n "${SCRIPTS_DIR:-}" && -d "$SCRIPTS_DIR" ]]; then
    src_dir="$SCRIPTS_DIR"
  elif [[ -n "${SCRIPT_DIR:-}" && -d "$SCRIPT_DIR" ]]; then
    src_dir="$SCRIPT_DIR"
  else
    local here; here="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    if [[ -d "$here" ]]; then
      src_dir="$here"
    else
      echo "link_tools: cannot locate scripts dir" >&2
      return 0
    fi
  fi

  local dest_dir="$HOME/bin"
  mkdir -p "$dest_dir"

  find "$src_dir" -maxdepth 1 -type f -print0 | xargs -0 chmod +x 2>/dev/null || true

  local linked=0
  while IFS= read -r -d '' src; do
    head -n1 "$src" | grep -q '^#!' || continue
    local base dest legacy
    base="$(basename "$src")"
    dest="$dest_dir/$base"
    ln -sfn "$src" "$dest"
    ok "linked: $dest -> $src"
    ((linked++)) || true
    legacy="${dest}.sh"
    if [[ -L "$legacy" && "$(readlink "$legacy")" == "$src" ]]; then
      rm -f "$legacy"
      warn "removed legacy link: $legacy"
    fi
  done < <(find "$src_dir" -maxdepth 1 -type f -print0)

  if [[ "$linked" -gt 0 ]]; then
    ok "Linked $linked tool(s) into $dest_dir"
  else
    warn "No tools linked"
  fi
}

run_defaults() {
  if [[ "$(uname -s)" != "Darwin" ]]; then
    warn "defaults only supported on macOS (Darwin)"
    return 0
  fi
  if [[ -f "${SCRIPTS_DIR}/defaults.sh" ]]; then
    run bash "${SCRIPTS_DIR}/defaults.sh"
  else
    warn "defaults.sh not found; skipping"
  fi
}

run_doctor() {
  PATH="$HOME/bin:$PATH" bash "${SCRIPTS_DIR}/doctor"
}

cmd="${1:-help}"
case "$cmd" in
  bootstrap)
    link_dotfiles
    link_tools
    run_defaults
    run_doctor
    ;;
  dotfiles)  link_dotfiles ;;
  tools)     link_tools ;;
  defaults)  run_defaults ;;
  doctor)    run_doctor ;;
  help | -h | --help) usage ;;
  *)
    err "unknown command: $cmd"
    usage
    exit 1
    ;;
esac
