#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

ok() { printf '\033[32m✓ %s\033[0m\n' "$*"; }
warn() { printf '\033[33m⚠ %s\033[0m\n' "$*"; }
err() { printf '\033[31m✗ %s\033[0m\n' "$*" >&2; }

MODE="${1:-check}" # check | --fix | fix
STATUS=0

check_localbin() {
  case ":$PATH:" in
    *":$HOME/.local/bin:"*) ok "${HOME}/.local/bin is on PATH" ;;
    *)
      warn "${HOME}/.local/bin is NOT on PATH"
      STATUS=1
      ;;
  esac
}

fix_localbin() {
  mkdir -p "$HOME/.local/bin"
  if ! grep -q ".local/bin" "${HOME}/.zshrc" 2>/dev/null; then
    # shellcheck disable=SC2016
    {
      echo ''
      echo '# Added by mrk1 doctor'
      echo '[ -d "$HOME/.local/bin" ] && case ":$PATH:" in *":$HOME/.local/bin:"*) ;; *) export PATH="$HOME/.local/bin:$PATH";; esac'
    } >>"${HOME}/.zshrc"
    ok "Added ~/.local/bin to PATH in .zshrc"
  fi
}

case "$MODE" in
  check)
    check_localbin
    exit "${STATUS}"
    ;;
  --fix | fix)
    fix_localbin
    ok "Fixes applied"
    exit 0
    ;;
  *)
    err "Unknown mode: $MODE"
    exit 2
    ;;
esac
