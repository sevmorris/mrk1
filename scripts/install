\
#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

ok() { printf '\033[32m✓ %s\033[0m\n' "$*"; }
warn() { printf '\033[33m⚠ %s\033[0m\n' "$*"; }
err() { printf '\033[31m✗ %s\033[0m\n' "$*" >&2; }

set -E -o errtrace
trap 'err "Failed at ${FUNCNAME[0]:-main} line $LINENO: $BASH_COMMAND"' ERR

HOME_DIR="${HOME}"
SCRIPT_PATH="${BASH_SOURCE[0]:-${0:-}}"
if [[ -n "${SCRIPT_PATH}" && -f "${SCRIPT_PATH}" ]]; then
  # shellcheck disable=SC2034
  SCRIPT_DIR="$(cd "$(dirname "${SCRIPT_PATH}")" && pwd)"
else
  # shellcheck disable=SC2034
  SCRIPT_DIR="$PWD"
fi

ensure_cli_tools() {
  if [[ "$(uname -s)" == "Darwin" ]]; then
    if ! xcode-select -p >/dev/null 2>&1; then
      xcode-select --install || true
      warn "Install Xcode Command Line Tools and re-run."
    else
      ok "Xcode CLT present"
    fi
  fi
}

install_core_brew() {
  echo "==> Installing core tools via Homebrew Bundle..."
  local bf_core
  bf_core="$(mktemp)"
  cat >"${bf_core}" <<'BREW'
brew "git"
brew "gh"
brew "zsh"
brew "coreutils"
brew "topgrade"
brew "bat"
brew "pwgen"
brew "shellcheck"
brew "shfmt"
BREW
  if command -v brew >/dev/null 2>&1; then
    brew bundle --file "${bf_core}" || true
  fi
  rm -f "${bf_core}"
  ok "Core brew ensured"
}

ensure_local_bin_on_path() {
  # shellcheck disable=SC2016
  SNIPPET=$(
    cat <<'EOF'
[ -d "$HOME/.local/bin" ] && case ":$PATH:" in *":$HOME/.local/bin:"*) ;; *) export PATH="$HOME/.local/bin:$PATH";; esac
EOF
  )

  local MARK_OPEN="# >>> mrk1 PATH >>>"
  local MARK_CLOSE="# <<< mrk1 PATH <<<"

  add_snippet() {
    local file="$1"
    if ! grep -q "$MARK_OPEN" "$file" 2>/dev/null; then
      {
        echo ""
        echo "$MARK_OPEN"
        echo "$SNIPPET"
        echo "$MARK_CLOSE"
      } >>"$file"
      ok "Added ${HOME}/.local/bin to PATH in ${file/$HOME_DIR/\~}"
    fi
  }

  mkdir -p "$HOME/.local/bin"
  touch "$HOME/.zshrc" "$HOME/.zprofile" "$HOME/.zshenv"
  add_snippet "$HOME/.zshrc"
  add_snippet "$HOME/.zprofile"
}

main() {
  ensure_cli_tools
  install_core_brew
  ensure_local_bin_on_path

  # hand off to Make if present
  if [[ -f "${SCRIPT_DIR}/../Makefile" ]]; then
    ( cd "${SCRIPT_DIR}/.." && make fix-exec && make bootstrap )
  fi
  ok "Install complete"
}

main "$@"
