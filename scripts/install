#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

ok() { printf '\033[32mâœ“ %s\033[0m\n' "$*"; }
warn() { printf '\033[33mâš  %s\033[0m\n' "$*"; }
err() { printf '\033[31mâœ— %s\033[0m\n' "$*" >&2; }

set -E -o errtrace
trap 'err "Failed at ${FUNCNAME[0]:-main} line $LINENO: $BASH_COMMAND"' ERR

HOME_DIR="${HOME}"
SCRIPT_PATH="${BASH_SOURCE[0]:-${0:-}}"
if [[ -n "${SCRIPT_PATH}" && -f "${SCRIPT_PATH}" ]]; then
  # shellcheck disable=SC2034
  SCRIPT_DIR="$(cd "$(dirname "${SCRIPT_PATH}")" && pwd)"
else
  # shellcheck disable=SC2034
  SCRIPT_DIR="$PWD"
fi

ensure_cli_tools() {
  if [[ "$(uname -s)" == "Darwin" ]]; then
    if ! xcode-select -p >/dev/null 2>&1; then
      xcode-select --install || true
      warn "Install Xcode Command Line Tools and re-run."
    else
      ok "Xcode CLT present"
    fi
  fi
}

install_core_brew() {
  echo "==> Installing core tools via Homebrew Bundle..."
  local bf_core
  bf_core="$(mktemp)"
  cat >"${bf_core}" <<'BREW'
brew "git"
brew "gh"
brew "zsh"
brew "coreutils"
brew "topgrade"
brew "bat"
brew "pwgen"
brew "shellcheck"
brew "shfmt"
BREW
  if command -v brew >/dev/null 2>&1; then
    brew bundle --file "${bf_core}" || true
  fi
  rm -f "${bf_core}"
  ok "Core brew ensured"
}

ensure_local_bin_on_path() {
  # shellcheck disable=SC2016
  SNIPPET=$(
    cat <<'EOF'
[ -d "$HOME/.local/bin" ] && case ":$PATH:" in *":$HOME/.local/bin:"*) ;; *) export PATH="$HOME/.local/bin:$PATH";; esac
EOF
  )

  local MARK_OPEN="# >>> mrk1 PATH >>>"
  local MARK_CLOSE="# <<< mrk1 PATH <<<"

  add_snippet() {
    local file="$1"
    if ! grep -q "$MARK_OPEN" "$file" 2>/dev/null; then
      {
        echo ""
        echo "$MARK_OPEN"
        echo "$SNIPPET"
        echo "$MARK_CLOSE"
      } >>"$file"
      ok "Added ${HOME}/.local/bin to PATH in ${file/$HOME_DIR/\~}"
    fi
  }

  mkdir -p "$HOME/.local/bin"
  touch "$HOME/.zshrc" "$HOME/.zprofile" "$HOME/.zshenv"
  add_snippet "$HOME/.zshrc"
  add_snippet "$HOME/.zprofile"
}

# NEW: robust tool linker (used here and in bootstrap)
link_tools() {
  # Determine scripts source dir
  local src_dir
  if [[ -n "${SCRIPTS_DIR:-}" && -d "$SCRIPTS_DIR" ]]; then
    src_dir="$SCRIPTS_DIR"
  elif [[ -n "${SCRIPT_DIR:-}" && -d "$SCRIPT_DIR" ]]; then
    src_dir="$SCRIPT_DIR"
  else
    local here; here="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    if [[ -d "$here" ]]; then
      src_dir="$here"
    else
      echo "link_tools: cannot locate scripts dir" >&2
      return 0
    fi
  fi

  local dest_dir="$HOME/.local/bin"
  mkdir -p "$dest_dir"

  # Ensure top-level files are executable
  find "$src_dir" -maxdepth 1 -type f -print0 | xargs -0 chmod +x 2>/dev/null || true

  local linked=0
  while IFS= read -r -d '' src; do
    head -n1 "$src" | grep -q '^#!' || continue
    local base dest legacy
    base="$(basename "$src")"
    dest="$dest_dir/$base"
    ln -sfn "$src" "$dest"
    echo "âœ“ linked: $dest -> $src"
    ((linked++)) || true
    legacy="${dest}.sh"
    if [[ -L "$legacy" && "$(readlink "$legacy")" == "$src" ]]; then
      rm -f "$legacy"
      echo "ðŸ§¹ removed legacy link: $legacy"
    fi
  done < <(find "$src_dir" -maxdepth 1 -type f -print0)

  if [[ "$linked" -gt 0 ]]; then
    echo "âœ… Linked $linked tool(s) into $dest_dir"
  else
    echo "â„¹ï¸ No tools linked (no shebang scripts found in $src_dir)"
  fi
}

main() {
  ensure_cli_tools
  install_core_brew
  ensure_local_bin_on_path
  # Ensure tools (including `syncall`) are linked immediately
  link_tools

  if [[ -f "${SCRIPT_DIR}/../Makefile" ]]; then
    (cd "${SCRIPT_DIR}/.." && make fix-exec && make bootstrap)
  fi
  ok "Install complete"
}

main "$@"
