#!/usr/bin/env bash
set -euo pipefail

# mrk1 installer - idempotent bootstrap for macOS (ASCII-only)

# Flags
ONLY=""
NO_BREW=0
NO_DOTFILES=0
NO_DEFAULTS=0
NO_LINK_TOOLS=0

while (("$#")); do
  case "$1" in
    --only) shift; ONLY="${1:-}" ;;
    --no-brew) NO_BREW=1 ;;
    --no-dotfiles) NO_DOTFILES=1 ;;
    --no-defaults) NO_DEFAULTS=1 ;;
    --no-link-tools) NO_LINK_TOOLS=1 ;;
    -h|--help)
      cat <<'USAGE'
mrk1 installer

Usage: scripts/install [options]
  --only <phase>     Run a single phase: brew|dotfiles|tools|defaults
  --no-brew          Skip Homebrew install/bundle
  --no-dotfiles      Skip dotfiles linking
  --no-defaults      Skip macOS defaults
  --no-link-tools    Skip linking scripts/bin into ~/.local/bin
USAGE
      exit 0
      ;;
    *) echo "Unknown option: $1" >&2; exit 2 ;;
  esac
  shift
done

# Paths
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
ASSETS="$REPO_ROOT/assets"
BIN_DIR="$REPO_ROOT/bin"
SCRIPTS_DIR="$REPO_ROOT/scripts"
LOGFILE="$HOME/mrk1-install.log"
LOCAL_BIN="$HOME/.local/bin"
BACKUP_DIR="$HOME/.mrk1/backups/$(date +%Y%m%d-%H%M%S)"

# Brewfile preference: assets/Brewfile, else root Brewfile
BREWFILE="$ASSETS/Brewfile"
if [[ -f "$REPO_ROOT/Brewfile" ]]; then
  BREWFILE="$REPO_ROOT/Brewfile"
fi

mkdir -p "$(dirname "$LOGFILE")" "$LOCAL_BIN" "$(dirname "$BACKUP_DIR")"

log()  { printf "[mrk1] %s\n" "$*"; }
warn() { printf "[warn] %s\n" "$*"; }
err()  { printf "[err ] %s\n" "$*"; }

# log to file and console
exec > >(tee -a "$LOGFILE") 2>&1
log "Starting install... (log: $LOGFILE)"

# Phase runner
run_phase() {
  local name="$1"; shift
  if [[ -n "$ONLY" && "$ONLY" != "$name" ]]; then return 0; fi
  "$@"
}

# Homebrew & bundle
phase_brew() {
  if (( NO_BREW )); then log "Skipping brew (flag)"; return; fi
  if ! command -v brew >/dev/null 2>&1; then
    log "Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    echo 'eval "$($(brew --prefix)/bin/brew shellenv)"' >> "$HOME/.zprofile"
    eval "$($(brew --prefix)/bin/brew shellenv)"
  else
    log "Homebrew present."
  fi

  if [[ -f "$BREWFILE" ]]; then
    log "Running brew bundle using $BREWFILE..."
    brew bundle --file="$BREWFILE" || warn "brew bundle returned non-zero"
  else
    warn "No Brewfile found; skipping bundle"
  fi
}

# Link scripts/bin into ~/.local/bin
phase_link_tools() {
  if (( NO_LINK_TOOLS )); then log "Skipping link-tools (flag)"; return; fi
  log "Linking scripts/* and bin/* into $LOCAL_BIN..."
  find "$SCRIPTS_DIR" -maxdepth 1 -type f -perm -u+x -exec bash -c '
    for f in "$@"; do
      base="$(basename "$f")"
      ln -sf "$f" "$LOCAL_BIN/$base"
    done
  ' _ {} +
  if [[ -d "$BIN_DIR" ]]; then
    find "$BIN_DIR" -maxdepth 1 -type f -perm -u+x -exec bash -c '
      for f in "$@"; do
        base="$(basename "$f")"
        ln -sf "$f" "$LOCAL_BIN/$base"
      done
    ' _ {} +
  fi
}

# Dotfiles with backups
phase_dotfiles() {
  if (( NO_DOTFILES )); then log "Skipping dotfiles (flag)"; return; fi
  local src dst
  mkdir -p "$BACKUP_DIR"
  shopt -s dotglob nullglob
  for src in "$REPO_ROOT/dotfiles"/*; do
    dst="$HOME/$(basename "$src")"
    if [[ -e "$dst" && ! -L "$dst" ]]; then
      log "Backing up: $dst -> $BACKUP_DIR/$(basename "$dst")"
      mv "$dst" "$BACKUP_DIR/" || warn "could not backup $dst"
    fi
    ln -sfn "$src" "$dst"
  done
  shopt -u dotglob nullglob
}

# macOS defaults + rollback
phase_defaults() {
  if (( NO_DEFAULTS )); then log "Skipping defaults (flag)"; return; fi
  if [[ -x "$SCRIPTS_DIR/defaults.sh" ]]; then
    "$SCRIPTS_DIR/defaults.sh"
  else
    warn "defaults.sh not found/executable; skipping"
  fi
}

# Change login shell to available zsh
phase_shell() {
  if command -v zsh >/dev/null 2>&1; then
    local target_shell
    target_shell="$(command -v zsh)"
    if [[ "$(dscl . -read "/Users/$USER" UserShell 2>/dev/null | awk '{print $2}')" != "$target_shell" ]]; then
      log "Setting login shell to $target_shell"
      chsh -s "$target_shell" || warn "chsh failed"
    else
      log "Login shell already $target_shell"
    fi
  fi
}

# Execute phases
run_phase brew     phase_brew
run_phase tools    phase_link_tools
run_phase dotfiles phase_dotfiles
run_phase defaults phase_defaults
run_phase shell    phase_shell

log "Install complete."
