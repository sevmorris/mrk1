#!/usr/bin/env bash
set -euo pipefail

# mrk1 status - check installation status

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
INSTALL_BIN="$HOME/bin"
STATE_DIR="$HOME/.mrk1"

ok()    { printf '\033[32m✓ %s\033[0m\n' "$*"; }
warn()  { printf '\033[33m⚠ %s\033[0m\n' "$*"; }
err()   { printf '\033[31m✗ %s\033[0m\n' "$*"; }
info()  { printf '  %s\n' "$*"; }

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "  mrk1 Installation Status"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# Check dotfiles (.zsh* only)
echo "Dotfiles (.zsh*):"
local zsh_linked=0
local zsh_missing=0

for zsh_file in "$HOME"/.zsh*; do
  [[ -e "$zsh_file" ]] || continue
  [[ -L "$zsh_file" ]] || continue
  
  local target
  target="$(readlink "$zsh_file" 2>/dev/null || true)"
  if [[ -n "$target" ]]; then
    # Check if it points to an mrk1 dotfiles directory
    if [[ "$target" == *"/.mrk1/repo/dotfiles/.zsh"* ]] || \
       [[ "$target" == *"/mrk1"*"/dotfiles/.zsh"* ]] || \
       [[ "$target" == *"/mrk1-dev"*"/dotfiles/.zsh"* ]] || \
       [[ "$target" == *"/dotfiles/.zsh"* ]]; then
      ((zsh_linked++))
    fi
  fi
done

# Check for expected .zsh* files that should be linked
local expected_zsh=(".zshrc" ".zshenv" ".zprofile")
for expected in "${expected_zsh[@]}"; do
  local file_path="$HOME/$expected"
  local link_target
  link_target="$(readlink "$file_path" 2>/dev/null || true)"
  if [[ ! -L "$file_path" ]] || [[ -z "$link_target" ]] || \
     [[ "$link_target" != *"/.mrk1/repo/dotfiles/.zsh"* ]] && \
     [[ "$link_target" != *"/dotfiles/.zsh"* ]]; then
    if [[ -e "$file_path" ]]; then
      warn "  Not linked: $expected (file exists but not from mrk1)"
    else
      info "  Not linked: $expected"
    fi
    ((zsh_missing++))
  fi
done

if (( zsh_linked > 0 )); then
  ok "  $zsh_linked .zsh* file(s) linked"
fi

if (( zsh_missing == 0 && zsh_linked > 0 )); then
  ok "  All expected .zsh* files linked"
fi
echo ""

# Check tools
echo "Tools:"
if [[ -d "$INSTALL_BIN" ]]; then
  local tool_count=0
  # Count tools that might be from mrk1 (heuristic: executable files)
  while IFS= read -r -d '' tool; do
    [[ -f "$tool" && -x "$tool" ]] && ((tool_count++))
  done < <(find "$INSTALL_BIN" -maxdepth 1 -type f -print0 2>/dev/null || true)
  
  if (( tool_count > 0 )); then
    ok "  $tool_count tool(s) in $INSTALL_BIN"
    info "  (Note: Tools are copied, not symlinked)"
  else
    info "  No tools found in $INSTALL_BIN"
  fi
else
  warn "  $INSTALL_BIN not found"
fi
echo ""

# Check defaults
echo "macOS Defaults:"
if [[ -f "$STATE_DIR/defaults-rollback.sh" ]] && [[ -s "$STATE_DIR/defaults-rollback.sh" ]]; then
  local rollback_lines
  rollback_lines=$(grep -c "defaults write\|defaults delete" "$STATE_DIR/defaults-rollback.sh" 2>/dev/null || echo "0")
  if (( rollback_lines > 0 )); then
    ok "  Defaults have been applied"
    info "  Rollback script: $STATE_DIR/defaults-rollback.sh"
    info "  ($rollback_lines change(s) can be rolled back)"
  else
    info "  No defaults applied"
  fi
else
  info "  No defaults applied"
fi
echo ""

# Check backups
echo "Backups:"
if [[ -d "$STATE_DIR/backups" ]]; then
  local backup_count
  backup_count=$(find "$STATE_DIR/backups" -mindepth 1 -maxdepth 1 -type d 2>/dev/null | wc -l | tr -d ' ')
  if (( backup_count > 0 )); then
    ok "  $backup_count backup(s) found"
    info "  Location: $STATE_DIR/backups"
    # Show most recent
    local latest
    latest=$(find "$STATE_DIR/backups" -mindepth 1 -maxdepth 1 -type d -print0 2>/dev/null | sort -zr | head -z -n1 | tr -d '\0')
    if [[ -n "$latest" ]]; then
      info "  Latest: $(basename "$latest")"
    fi
  else
    info "  No backups found"
  fi
else
  info "  No backups directory"
fi
echo ""

# Check shell
echo "Shell:"
if command -v zsh >/dev/null 2>&1; then
  local current_shell
  current_shell="$(dscl . -read "/Users/$USER" UserShell 2>/dev/null | awk '{print $2}')" || current_shell="unknown"
  local zsh_path
  zsh_path="$(command -v zsh)"
  if [[ "$current_shell" == "$zsh_path" ]]; then
    ok "  Login shell: $current_shell"
  else
    warn "  Login shell: $current_shell (expected: $zsh_path)"
  fi
else
  warn "  zsh not found"
fi
echo ""

# Check PATH
echo "PATH:"
case ":$PATH:" in
  *":$INSTALL_BIN:"*)
    ok "  $INSTALL_BIN is on PATH"
    ;;
  *)
    warn "  $INSTALL_BIN is NOT on PATH"
    info "  Add to your .zshrc: export PATH=\"\$HOME/bin:\$PATH\""
    ;;
esac
echo ""

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

