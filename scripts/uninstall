#!/usr/bin/env bash
set -euo pipefail

# mrk1 uninstaller - conservative
# - Unlinks ~/.local/bin symlinks pointing into this repo
# - Optionally runs ~/.mrk1/defaults-rollback.sh
# - Does not remove Homebrew or user data

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
LOCAL_BIN="$HOME/.local/bin"

log(){ printf "[uninstall] %s\n" "$*"; }
warn(){ printf "[warn] %s\n" "$*"; }

log "Unlinking mrk1 symlinks from $LOCAL_BIN..."
if [[ -d "$LOCAL_BIN" ]]; then
  find "$LOCAL_BIN" -type l -exec bash -c '
    for L in "$@"; do
      T="$(readlink "$L" 2>/dev/null || true)"
      case "$T" in
        *"/scripts/"*|*"/bin/"*)
          if [[ -n "$T" && -e "$T" && "$T" == "'"$REPO_ROOT"'"* ]]; then
            rm -f "$L" && echo "- removed $L -> $T"
          fi
          ;;
      esac
    done
  ' _ {} +
else
  warn "$LOCAL_BIN not found"
fi

ROLLBACK="$HOME/.mrk1/defaults-rollback.sh"
if [[ -x "$ROLLBACK" ]]; then
  read -r -p "Run macOS defaults rollback now? [y/N] " ans
  if [[ "$ans" =~ ^[Yy]$ ]]; then
    log "Running $ROLLBACK..."
    "$ROLLBACK" || warn "rollback returned non-zero"
  else
    log "Skipped defaults rollback (you can run it later)."
  fi
else
  log "No defaults rollback script present at $ROLLBACK (nothing to do)."
fi

log "Uninstall complete."
