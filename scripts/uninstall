#!/usr/bin/env bash
set -euo pipefail

# mrk1 uninstaller — reverses what the installer did, conservatively
# - Unlinks symlinks in ~/.local/bin that point into this repo's scripts/ or bin/
# - Optionally runs ~/.mrk1/defaults-rollback.sh if present
# - Does NOT delete Homebrew or user data

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
LOCAL_BIN="$HOME/.local/bin"

log(){ printf "\033[1;34m[uninstall]\033[0m %s\n" "$*"; }
warn(){ printf "\033[1;33m[warn]\033[0m %s\n" "$*"; }

log "Unlinking mrk1 symlinks from $LOCAL_BIN…"
if [[ -d "$LOCAL_BIN" ]]; then
  find "$LOCAL_BIN" -type l -exec bash -c '
    for L in "$@"; do
      T="$(readlink "$L" 2>/dev/null || true)";
      case "$T" in
        *"/scripts/"*|*"/bin/"*)
          # Only remove links that point back into this repo
          if [[ -n "$T" && -e "$T" && "$T" == '"'"'$REPO_ROOT'"'"'* ]]; then
            rm -f "$L" && echo "- removed $L -> $T";
          fi
          ;;
      esac
    done
  ' _ {} +
else
  warn "$LOCAL_BIN not found"
fi

ROLLBACK="$HOME/.mrk1/defaults-rollback.sh"
if [[ -x "$ROLLBACK" ]]; then
  read -r -p "Run macOS defaults rollback now? [y/N] " ans
  if [[ "$ans" =~ ^[Yy]$ ]]; then
    log "Running $ROLLBACK…"
    "$ROLLBACK" || warn "rollback returned non-zero"
  else
    log "Skipped defaults rollback (you can run it later)."
  fi
else
  log "No defaults rollback script present at $ROLLBACK (nothing to do)."
fi

log "Uninstall complete."
